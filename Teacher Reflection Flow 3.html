<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Reflection Flow: CBE & Learning Outcomes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcfcfc; /* Soft Off-White Background */
        }
        .reflection-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.4s ease-out;
            border-left: 8px solid #06b6d4; /* Cyan 500 accent border */
            scroll-margin-top: 20px;
        }
        .reflection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }
        .reflection-card.completed {
            border-left-color: #4ade80; /* Vibrant Green 400 for completed cards */
            opacity: 0.6; /* Slight fade when complete and hidden to show progress */
            pointer-events: none; /* Disable interaction */
        }
        .rating-button {
            transition: transform 0.15s ease-out, background-color 0.15s, box-shadow 0.15s;
            transform: scale(0.95);
        }
        .rating-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .rating-button.selected {
            background-color: #4ade80; /* Vibrant Green 400 for selected */
            color: white;
            border-color: #22c55e;
            transform: scale(1.05);
        }
        /* Custom styles for the 3 diagnostic questions */
        .diagnostic-options {
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .diagnostic-option {
            transition: background-color 0.2s;
            border: 1px solid #d1d5db;
        }
        .diagnostic-option:hover {
            background-color: #f3f4f6;
        }
        .diagnostic-option.selected {
            background-color: #d1fae5; /* Light Green */
            border-color: #34d399; /* Medium Green */
            font-weight: 600;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        /* Style for the wrappers of the diagnostic questions */
        .diagnostic-q-wrapper {
            transition: opacity 0.5s ease-in-out, max-height 0.5s ease-in-out, padding 0.5s;
            overflow: hidden;
            max-height: 1000px;
        }
        /* The initial 'hidden' state for diagnostic questions */
        .diagnostic-q-wrapper.initial-hidden {
             /* Max-height is used to manage visibility during sequential reveal */
            max-height: 0; 
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }
        /* When an option is answered, make the question read-only and slightly faded */
        .diagnostic-q-wrapper.answered {
            pointer-events: none;
            opacity: 0.8;
            margin-bottom: 1rem; 
            border-bottom: 1px dashed #e5e7eb;
            padding-bottom: 1rem;
        }


        .task-box {
            background-color: #f0fdf4; /* Lightest Mint Green background */
            border: 1px solid #dcfce7;
        }
        /* Styling for the animated feedback area */
        .feedback-area {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.5s ease-out, max-height 0.7s ease-out, padding 0.5s;
            padding: 0 1rem;
            background-color: #f5f3ff; /* Light Violet/Purple 50 background */
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .feedback-area.visible {
            opacity: 1;
            max-height: 1000px; /* Increased max-height for diagnostic section */
            padding: 1rem;
        }
        /* Custom styling for a vibrant reflection container */
        .reflection-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        /* Styling for single question visibility */
        .question-wrapper {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .question-wrapper.hidden {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }
        .question-wrapper.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        /* Custom styles for the direct choice selection (Q6/Q7) */
        .direct-choice-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .direct-choice {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            background-color: #f9fafb;
        }
        .direct-choice:hover {
            background-color: #f3f4f6;
            border-color: #67e8f9; /* Cyan 300 */
        }
        .direct-choice.selected {
            background-color: #d1fae5; /* Light Green */
            border-color: #34d399; /* Medium Green */
            font-weight: 600;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

    </style>
</head>
<body>

    <div id="app" class="reflection-container">

        <!-- Header -->
        <header class="text-center mb-10 p-4 bg-white rounded-xl shadow-lg border-b-4 border-cyan-500">
            <h1 class="text-3xl font-bold text-gray-800 mb-1">Interactive Reflection Flow</h1>
            <p class="text-md text-cyan-600 font-semibold">
                Lesson Competency: Understanding Curricular Goals, CBE, and Learning Outcomes
            </p>
        </header>
        
        <!-- Progress Bar (New Feature) -->
        <div class="mb-8 p-4 bg-white rounded-xl shadow-md border border-gray-100">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Your Progress</h3>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-cyan-500 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-xs text-gray-500 mt-1 text-right">0 of 7 reflections complete</p>
        </div>

        <!-- Intro (Warm-up) -->
        <div class="mb-10 p-6 bg-amber-50 rounded-xl border border-amber-200">
            <h2 class="text-xl font-bold text-amber-700 mb-3">ðŸ‘‹ Let's Get Started!</h2>
            <p class="text-gray-700 leading-relaxed">
                Hi! Before we dive into competency-based education, letâ€™s take a moment to reflect on your classroom practices. This flow will adapt to your answers, guiding you through personalized steps. There are no right or wrong answers. First, click on a number (1-5) to reflect on the scenario, then answer the follow-up diagnostic questions!
            </p>
        </div>

        <!-- Reflection Sections will be injected here -->
        <div id="reflections-list" class="space-y-8">
            <!-- Content generated by JS -->
        </div>

        <!-- Wrap-Up Summary (Initially hidden) -->
        <div id="wrap-up-summary" class="hidden mt-12 p-8 bg-emerald-100 rounded-xl border-t-8 border-emerald-500 shadow-xl">
            <h2 class="text-2xl font-bold text-emerald-800 mb-4 flex items-center">
                <span class="mr-2 text-3xl">ðŸŒ¼</span> Your Reflection Summary
            </h2>
            <p id="summary-text" class="text-gray-700 leading-relaxed text-lg">
                <!-- Summary text injected here -->
            </p>
            <p class="mt-4 text-sm text-emerald-600 font-medium">
                Keep reflecting and trying these small steps â€” they help make learning meaningful for your students!
            </p>
        </div>

    </div>

    <script>
        // Total number of core reflection steps (7 core scenarios are mandatory)
        const TOTAL_CORE_STEPS = 7; 
        
        // --- REFLECTION STRUCTURE ---
        // Each object is a CORE SCENARIO (7 total).
        // type: "rating" uses 1-5 scale + 3 diagnostic Qs.
        // type: "choice" uses direct choice selection (Q6 & Q7).
        const REFLECTIONS = [
            // ----------------------------------------------------
            // CORE SCENARIO 1: Goal Clarity & Planning (User Q1)
            // ----------------------------------------------------
            {
                id: 1,
                title: "Goal Clarity & Planning",
                coreArea: "Lesson Planning",
                type: "rating",
                prompt: "I start planning my lessons with a clear idea of what I want students to be able to **do** by the end.",
                diagnostic: {
                    q1: "What is the **biggest challenge** in setting a clear learning goal before you plan?",
                    q2: "When you start planning a new lesson, where do you **usually focus your energy first**?",
                    q3: "How often do you struggle with **keeping activities connected** across a full unit?",
                    
                    options: [
                        // Option Set A (1-2) - Low Clarity
                        { 
                            key: "a1", 
                            q1_options: ["I feel rushed, so I start with the first activity.", "Curriculum goals are too vague for daily planning.", "I prefer being flexible and seeing where the lesson goes."],
                            q2_options: ["Reading the next page/section in the textbook.", "Finding teaching resources or materials.", "Reviewing past test results from the previous unit."],
                            q3_options: ["My activities often drift from the main goal.", "I rarely check how activities in the unit fit together.", "I find it hard to fit skills (like critical thinking) into my lessons."],
                        },
                        // Option Set B (3) - Moderate Clarity
                        { 
                            key: "b1", 
                            q1_options: ["It takes too much time and preparation.", "The topic is complex, and I'm unsure which part to prioritize.", "I check the main goal, but don't refine it into a simple student outcome."],
                            q2_options: ["Drafting the main activity or worksheet.", "Planning the structure of the introduction and conclusion.", "Creating an end-of-lesson assessment (like an exit ticket)."],
                            q3_options: ["I usually align activities, but not all of them.", "I sometimes forget to link activities to the unit's bigger outcome.", "I find it hard to connect 'application' skills across multiple lessons."],
                        },
                        // Option Set C (4-5) - High Clarity
                        { 
                            key: "c1", 
                            q1_options: ["Nothing is a barrier; defining the goal is the first step.", "The complexity of coordinating assessment across a long-term unit.", "It requires extra planning time, but the payoff is worth it."],
                            q2_options: ["Writing the measurable learning goal on the board or in my lesson plan.", "Designing the quick check for student understanding that ends the lesson.", "Planning for both struggling and excelling students."],
                            q3_options: ["Hardly ever; my lessons are clearly sequenced and linked.", "Only when introducing complex, interdisciplinary topics.", "When I forget to write down my learning outcomes for the unit."],
                        },
                    ]
                },
                task: "ðŸŒ± **Actionable Task:** For your next lesson, summarize the goal in one sentence: 'By the end of this lesson, students will be able to...' and write it on the board.",
            },
            // ----------------------------------------------------
            // CORE SCENARIO 2: Skill-Based Activity Design (User Q2)
            // ----------------------------------------------------
            {
                id: 2,
                title: "Skill-Based Activity Design",
                coreArea: "Skill Practice (Problem-Solving)",
                type: "rating",
                prompt: "I plan activities that help students **practice skills** like problem-solving, communication, or critical thinking, not just memorize facts.",
                diagnostic: {
                    q1: "What is the **main reason** you sometimes use memory tasks (recall) instead of skill tasks (analysis)?",
                    q2: "When designing a skill task, what part of the preparation do you find **most challenging**?",
                    // High Score Q3: Pushes for secondary skill focus
                    q3: "If you are confident in teaching problem-solving, which **secondary skill** do you want to focus on this term?",
                    
                    options: [
                        // Option Set A (1-2) - Low Skill Focus
                        { 
                            key: "a2", 
                            q1_options: ["It's easier to grade tasks based on memory.", "I worry skill tasks take up too much lesson time.", "The textbook only provides recall questions."],
                            q2_options: ["Creating a situation that truly requires problem-solving.", "Finding time to listen to every small group and give feedback.", "Creating a clear grading rubric for soft skills."],
                            q3_options: ["Solving the problem correctly using the steps taught.", "Finding the right answer.", "Recalling the steps needed to solve a specific problem type."],
                        },
                        // Option Set B (3) - Moderate Skill Focus
                        { 
                            key: "b2", 
                            q1_options: ["I use skill tasks sometimes, but only for simple topics.", "I struggle to link skill tasks directly to the main lesson outcome.", "My students lack the confidence for open-ended challenges."],
                            q2_options: ["Ensuring the activity is challenging enough for advanced students.", "Setting up the classroom for effective group discussion.", "Translating the skill into student-friendly instructions."],
                            q3_options: ["Applying the concept to a new, but simple scenario.", "Breaking down a complex task into smaller steps.", "Working effectively with a partner."],
                        },
                        // Option Set C (4-5) - High Skill Focus
                        { 
                            key: "c2", 
                            q1_options: ["I believe skills are more important than recall for long-term mastery.", "I only use recall tasks as a short warm-up activity.", "I find skill tasks more engaging to teach."],
                            q2_options: ["Ensuring all materials needed for the complex task are ready.", "Preparing extension challenges for students who finish the main task quickly.", "Managing the 'active discussion noise' that comes with skill practice."],
                            q3_options: ["Critical thinking (evaluating sources).", "Communication (structured debate/presentation).", "Collaboration (leading a group task)."],
                        },
                    ]
                },
                task: "ðŸŒ± **Actionable Task:** Take one concept from your next lesson and create a single task that starts with the phrase: 'Using this information, design a solution for...'",
            },
            // ----------------------------------------------------
            // CORE SCENARIO 3: Student Agency & Voice (User Q3)
            // ----------------------------------------------------
            {
                id: 3,
                title: "Student Agency & Voice",
                coreArea: "Student Agency",
                type: "rating",
                prompt: "My students are actively engaged (asking questions, explaining answers) without always needing me to prompt them.",
                diagnostic: {
                    q1: "What do you feel is the **main barrier** when inviting students to explain or ask questions?",
                    q2: "How would you describe the general **emotional tone** of your classroom during a lesson?",
                    // High Score Q3: Focuses on equity of voice
                    q3: "What stops you from setting up a system where **every student gets to speak**?",
                    
                    options: [
                        // Option Set A (1-2) - Low Agency
                        { 
                            key: "a3", 
                            q1_options: ["Fear of failure or being corrected publicly.", "They don't know *how* to explain their thinking yet.", "Language barrier or shyness."],
                            q2_options: ["Quiet and disciplined, but passive/reserved.", "Restless and easily distracted.", "Focused on individual competition."],
                            q3_options: ["I worry it will take up too much time.", "I worry the discussion will stray from the topic.", "I prefer giving my own detailed explanation."],
                        },
                        // Option Set B (3) - Moderate Agency
                        { 
                            key: "b3", 
                            q1_options: ["They need specific sentence starters to know exactly how to share.", "They only talk when prompted directly.", "Lack of clear consequence for non-participation."],
                            q2_options: ["Generally cooperative, but easily distracted or passive.", "Active in small bursts, then return to quiet work.", "Focused on getting the right answer quickly."],
                            q3_options: ["The topic is complex, and I'm unsure which concept to prioritize.", "I sometimes forget to add time for questions.", "It's challenging to manage large group discussions."],
                        },
                        // Option Set C (4-5) - High Agency
                        { 
                            key: "c3", 
                            q1_options: ["Nothing holds them back; managing time/noise from participation is the challenge.", "They prefer explaining to me, not to peers.", "They often rush their explanations."],
                            q2_options: ["Energetic and curious, sometimes leading to productive chaos.", "Challenged and focused on problem-solving.", "Confident and willing to try new ideas."],
                            q3_options: ["Nothing prevents it; I build flexibility into my planning schedule.", "I worry that only the most confident students dominate the conversation.", "I find it hard to track participation equally across large groups."],
                        },
                    ]
                },
                task: "ðŸŒ± **Actionable Task:** Introduce the 'Think-Pair-Share' technique for one complex idea. Give students 30 seconds of quiet thinking time before asking them to talk.",
            },
            // ----------------------------------------------------
            // CORE SCENARIO 4: Assessment for Application (User Q4)
            // ----------------------------------------------------
            {
                id: 4,
                title: "Assessment for Application",
                coreArea: "Application & AFL",
                type: "rating",
                prompt: "I check if students can **apply** what they learn (e.g., to a real-life scenario), not just remember it.",
                diagnostic: {
                    q1: "What is the **primary difficulty** in creating tasks that check for real-life application?",
                    q2: "When you *do* check for application, what is your most common method?",
                    // High Score Q3: Focuses on scaling the check for equity
                    q3: "How do you ensure your application checks are **easy to manage for a large class**?",
                    
                    options: [
                        // Option Set A (1-2) - Low Application Check
                        { 
                            key: "a4", 
                            q1_options: ["I don't have enough real-life examples prepared.", "I worry about interrupting the lesson flow with checks.", "It takes too long to collect and review all the answers."],
                            q2_options: ["Asking a single recall question verbally.", "A simple True/False or multiple-choice question.", "Assigning a homework problem."],
                            q3_options: ["Briefly repeating the explanation and trying a new example.", "Leaving it and hoping they understand it later.", "Assigning a lot of homework on the same topic."],
                        },
                        // Option Set B (3) - Moderate Application Check
                        { 
                            key: "b4", 
                            q1_options: ["I worry that quick checks might distract students from the main activity.", "Ensuring the quick check genuinely tests *application*, not just memory.", "I can design the task but recording the results is hard."],
                            q2_options: ["A short, one-sentence exit ticket.", "A quick hands-up check (e.g., thumbs-up/down).", "A small group discussion on a scenario."],
                            q3_options: ["Using a different teaching method (e.g., a diagram or a role-play) to re-teach the concept.", "Pairing them with a high-performing student to get help.", "Stopping the class for a brief 5-minute review."],
                        },
                        // Option Set C (4-5) - High Application Check
                        { 
                            key: "c4", 
                            q1_options: ["I do not find it challenging; I have quick, effective methods.", "The challenge is ensuring the check is tied to a real-life context.", "Scaling up the check for larger classes."],
                            q2_options: ["A targeted mini-task where they have to *use* the concept in a new way.", "Observation checklist during an application-based group activity.", "An oral presentation where they explain the process."],
                            q3_options: ["Instantly grouping students who struggled for targeted help while others move on.", "Giving them an immediate, simplified application problem to solve.", "Using the student error as a teachable moment for the whole class."],
                        },
                    ]
                },
                task: "ðŸŒ± **Actionable Task:** Design one 'What If' question for your next lesson. (Example: 'What if you forgot the formula? How would you solve the problem?').",
            },
            // ----------------------------------------------------
            // CORE SCENARIO 5: Feedback Loop & Adjustment (User Q5)
            // ----------------------------------------------------
            {
                id: 5,
                title: "Feedback Loop & Adjustment",
                coreArea: "Feedback Loop & Planning",
                type: "rating",
                prompt: "I use what I learn from student responses/work to **adjust my next lesson's content, pace, or grouping**.",
                diagnostic: {
                    q1: "What prevents you from **always** adjusting your next lesson based on student feedback?",
                    q2: "When you *do* adjust, what does that change **usually look like**?",
                    // High Score Q3: Focuses on closing the loop
                    q3: "What is your method for checking if your **adjustment actually worked**?",
                    
                    options: [
                        // Option Set A (1-2) - Low Adjustment
                        { 
                            key: "a5", 
                            q1_options: ["The pressure of the syllabus and needing to move on to the next topic.", "I don't have a clear way to summarize all the student errors quickly.", "I rely on the end-of-unit test, not daily feedback."],
                            q2_options: ["I slow down the pace or reteach the entire concept to the whole class.", "I assign extra homework to reinforce the idea.", "I ignore the result and continue with the original plan."],
                            q3_options: ["I keep the key insights in my mind but don't formally record them.", "I throw away the papers after correcting them.", "I write general comments like 'Study More.'"],
                        },
                        // Option Set B (3) - Moderate Adjustment
                        { 
                            key: "b5", 
                            q1_options: ["I struggle to quickly find the single biggest misconception.", "It is difficult to create a new activity on the spot.", "I don't trust my ability to change the plan effectively."],
                            q2_options: ["I add one or two extra practice problems the next day to reinforce the idea.", "I ask a few students what they struggled with and address that.", "I briefly mention the common mistake to the whole class."],
                            q3_options: ["I write quick notes on the margin of my lesson plan, but they can be disorganized.", "I use a small, unstructured notebook for random notes.", "I tell myself I'll remember the feedback later."],
                        },
                        // Option Set C (4-5) - High Adjustment (UPDATED OPTIONS)
                        { 
                            key: "c5", 
                            q1_options: ["Nothing; I build flexibility into my planning schedule.", "The only issue is finding the best targeted resource for intervention.", "Ensuring the adjustment doesn't feel like punishment to the students."],
                            q2_options: ["I instantly identify students who need support and plan a small-group intervention for them the next day.", "I use the error to revise the lesson's learning goal for the next class.", "I create a whole-class activity designed specifically to address the root mistake."],
                            q3_options: ["I use a notebook or sheet to record specific student names and errors.", "I follow up the next day to measure if the adjustment worked.", "I adjust the next day's learning goal based on the feedback."],
                        },
                    ]
                },
                task: "ðŸŒ± **Actionable Task:** After your next lesson, identify two students who struggled most and two students who excelled. Note one specific adjustment for each group for your next lesson.",
            },
            // ----------------------------------------------------
            // CORE SCENARIO 6: Lesson Focus: Mastery vs. Coverage (User Q6 - Direct Choice)
            // ----------------------------------------------------
            {
                id: 6,
                title: "Lesson Focus: Mastery vs. Coverage",
                coreArea: "Mastery Focus",
                type: "choice",
                prompt: "At the end of a lesson, my main check for learning is: (Select the option closest to your primary practice)",
                choices: [
                    "If I finished the planned content.",
                    "If students can recall key facts.",
                    "If students can explain ideas in their own words.",
                    "If students can use the learning in a real-life scenario.",
                ],
                // Simplified diagnostic feedback based on choice text
                diagnostic: {
                    q1: "At the end of a lesson, my main check for learning is:",
                    q2: "Reason for this focus:",
                    q3: "Suggested action:",
                },
                task: "ðŸŒ± **Actionable Task:** Identify the **one most important fact** and the **one most important application** for your next lesson. If you only have time for one, choose the application.",
            },
            // ----------------------------------------------------
            // CORE SCENARIO 7: Targeted Support & Intervention (User Q7 - Direct Choice)
            // ----------------------------------------------------
            {
                id: 7,
                title: "Targeted Support & Intervention",
                coreArea: "Intervention Strategy",
                type: "choice",
                prompt: "When a student struggles to learn something, I usually: (Select the option closest to your primary practice)",
                choices: [
                    "Move on to the next topic and hope they catch up later.",
                    "Repeat the same explanation in the same way as before.",
                    "Identify whether the gap is in the concept or skill, then give targeted support.",
                    "Pair the student with a peer or give extra time and activities for practice.",
                ],
                // Simplified diagnostic feedback based on choice text
                diagnostic: {
                    q1: "When a student struggles to learn something, I usually:",
                    q2: "Reason for this action:",
                    q3: "Suggested improvement:",
                },
                task: "ðŸŒ± **Actionable Task:** Identify one student you know is struggling. Write down your theory about *why* they struggle (concept gap or skill gap). Design one specific, 5-minute task to test your theory.",
            },
        ];

        const results = {};
        const reflectionsList = document.getElementById('reflections-list');
        const summaryDiv = document.getElementById('wrap-up-summary');
        const summaryText = document.getElementById('summary-text');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        // Helper function to find reflection object by ID
        const getReflectionById = (id) => REFLECTIONS.find(r => r.id === id);

        // --- PROGRESS AND RENDERING FUNCTIONS ---

        function renderReflections() {
            reflectionsList.innerHTML = REFLECTIONS.map(r => {
                const visibilityClass = r.id === 1 ? 'active' : 'hidden';
                let ratingButtonsHTML = '';
                let diagnosticContainerHTML = '';

                if (r.type === 'rating') {
                    ratingButtonsHTML = `
                        <div class="flex space-x-2 mb-4 justify-center sm:justify-start">
                            ${[1, 2, 3, 4, 5].map(rating => `
                                <button
                                    data-id="${r.id}"
                                    data-rating="${rating}"
                                    onclick="handleRatingClick(this)"
                                    class="rating-button w-10 h-10 rounded-full border-2 border-teal-400 text-teal-600 font-bold bg-teal-50 hover:bg-teal-100 focus:outline-none focus:ring-4 focus:ring-teal-300"
                                >
                                    ${rating}
                                </button>
                            `).join('')}
                        </div>
                        <div id="diagnostic-container-${r.id}"></div>
                    `;
                } else if (r.type === 'choice') {
                    ratingButtonsHTML = `
                        <div class="direct-choice-list my-4" id="choice-list-${r.id}">
                            ${r.choices.map((choice, index) => `
                                <div
                                    class="direct-choice text-gray-700"
                                    data-id="${r.id}"
                                    data-choice="${choice.replace(/\"/g, "'")}"
                                    data-index="${index + 1}"
                                    onclick="handleChoiceClick(this)"
                                >
                                    ${choice}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                <div id="wrapper-${r.id}" class="question-wrapper ${visibilityClass} space-y-8">
                    <div id="reflection-${r.id}" class="reflection-card bg-white p-6 rounded-xl">
                        <!-- Title and Prompt will be dynamically set here -->
                        <div id="title-${r.id}"></div>
                        <p id="prompt-${r.id}" class="text-gray-600 mb-4"></p>

                        ${ratingButtonsHTML}

                        <!-- Adaptive Feedback Area -->
                        <div id="feedback-${r.id}" class="feedback-area">
                            <p class="text-violet-700 italic mb-3" id="follow-up-${r.id}"></p>
                            <div class="task-box p-3 rounded-lg text-sm text-green-800 font-medium" id="task-${r.id}"></div>
                            <button 
                                data-id="${r.id}"
                                onclick="moveToNextQuestion(this.getAttribute('data-id'))"
                                id="feedback-continue-btn-${r.id}"
                                class="mt-4 px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg hover:bg-cyan-700 transition duration-150 w-full"
                            >
                                Continue to Next Reflection &rarr;
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // Render the first question content (Q1)
            renderReflectionCard(1);
            updateProgress();
        }

        function updateProgress() {
            const completedCount = Object.keys(results).length;
            const percentage = (completedCount / TOTAL_CORE_STEPS) * 100;

            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${completedCount} of ${TOTAL_CORE_STEPS} reflections complete`;
        }

        // Renders the specific content for a single reflection card
        function renderReflectionCard(id) {
            const reflection = getReflectionById(id);
            if (!reflection) return;

            const formattedPrompt = reflection.prompt.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Render the core 1-5 rating section
            document.getElementById(`title-${id}`).innerHTML = 
                `<h3 class="text-xl font-semibold text-gray-800 mb-2">${reflection.title}</h3>`;
            
            const promptSuffix = reflection.type === 'rating' ? '<span class="font-bold">(1 = Never, 5 = Always)</span>' : '';
            
            document.getElementById(`prompt-${id}`).innerHTML = 
                `${formattedPrompt} ${promptSuffix}`;
            
            // Inject the diagnostic section for 'rating' type questions
            if (reflection.type === 'rating') {
                document.getElementById(`diagnostic-container-${id}`).innerHTML = `
                    <div id="diagnostic-questions-${id}" class="diagnostic-options hidden space-y-4">
                        <p class="text-gray-700 font-semibold mb-3 border-b pb-1">Great! Now, let's explore **why** you feel this way (select the best fit for each):</p>
                        
                        ${renderDiagnosticQuestion(id, 'q1', reflection.diagnostic.q1, true)}
                        ${renderDiagnosticQuestion(id, 'q2', reflection.diagnostic.q2, true)}
                        ${renderDiagnosticQuestion(id, 'q3', reflection.diagnostic.q3, true)}
                        
                    </div>
                `;
            }
        }

        // Renders a single diagnostic question with its options (for type: 'rating')
        function renderDiagnosticQuestion(coreId, qKey, questionText, initiallyHidden = false) {
            const hiddenClass = initiallyHidden ? 'initial-hidden' : '';
            return `
                <div class="space-y-2 diagnostic-q-wrapper ${hiddenClass}" data-diagnostic-q="${qKey}" id="q-wrapper-${coreId}-${qKey}">
                    <p class="text-gray-600 font-medium">${questionText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                    <div class="space-y-1" id="options-${coreId}-${qKey}">
                        <!-- Options will be dynamically injected here in handleRatingClick -->
                    </div>
                </div>
            `;
        }
        
        // Renders the unique options for a single diagnostic question (for type: 'rating')
        function renderUniqueOptions(coreId, qKey, optionsArray) {
            return optionsArray.map((text, index) => `
                <div 
                    data-core-id="${coreId}"
                    data-q-key="${qKey}"
                    data-q-index="${index}"
                    data-text="${text.replace(/\"/g, "'")}"
                    onclick="handleDiagnosticClick(this)"
                    class="diagnostic-option p-3 rounded-lg cursor-pointer text-sm text-gray-700"
                >
                    ${text}
                </div>
            `).join('');
        }
        
        // --- HANDLERS ---

        // Function to handle the core 1-5 rating click (for type: 'rating')
        function handleRatingClick(button) {
            const id = parseInt(button.getAttribute('data-id'));
            const rating = parseInt(button.getAttribute('data-rating'));
            const reflection = getReflectionById(id);

            if (!reflection || reflection.type !== 'rating') return;

            // 1. Store core rating
            if (!results[id]) {
                results[id] = { coreRating: rating, diagnostic: {} };
            } else {
                results[id].coreRating = rating;
            }

            // 2. Highlight the current button
            const container = button.closest('.reflection-card');
            container.querySelectorAll('.rating-button').forEach(btn => {
                btn.classList.remove('selected', 'bg-emerald-500', 'text-white');
                btn.classList.add('bg-teal-50', 'text-teal-600');
            });
            button.classList.add('selected', 'bg-emerald-500', 'text-white');
            button.classList.remove('bg-teal-50', 'text-teal-600');
            
            // 3. Determine which set of options to show (a, b, or c) for the diagnostic
            let optionSetKey;
            if (rating <= 2) {
                optionSetKey = "a"; // Low score path
            } else if (rating === 3) {
                optionSetKey = "b"; // Medium score path
            } else { // 4 or 5
                optionSetKey = "c"; // High score path
            }
            
            // Find the correct option set data (e.g., 'a1' or 'c2')
            const optionData = reflection.diagnostic.options.find(o => o.key.startsWith(optionSetKey));

            if (!optionData) {
                console.error("Option data not found for key:", optionSetKey);
                return;
            }

            // 4. Dynamically inject the unique options for Q1
            const diagnosticQuestionsDiv = document.getElementById(`diagnostic-questions-${id}`);
            
            // Reset visibility of all diagnostic questions and remove answered class
            container.querySelectorAll('.diagnostic-q-wrapper').forEach(wrapper => {
                wrapper.classList.add('initial-hidden');
                wrapper.classList.remove('answered');
            });

            // Using the dedicated qX_options array for each question to ensure unique options
            const q1Options = optionData.q1_options.sort(() => 0.5 - Math.random());
            document.getElementById(`options-${id}-q1`).innerHTML = renderUniqueOptions(id, 'q1', q1Options);

            // Store options data for Q2 and Q3 for later use
            results[id].q2OptionsData = optionData.q2_options.sort(() => 0.5 - Math.random());
            results[id].q3OptionsData = optionData.q3_options.sort(() => 0.5 - Math.random());
            
            // Show the diagnostic questions container
            diagnosticQuestionsDiv.classList.remove('hidden');

            // Show Q1 immediately
            document.getElementById(`q-wrapper-${id}-q1`).classList.remove('initial-hidden');

            // 5. Hide the feedback area until the diagnostic is complete
            document.getElementById(`feedback-${id}`).classList.remove('visible');
            
            // 6. Set the diagnostic key and clear previous selections if the rating changed
            results[id].diagnosticKey = optionSetKey;
            results[id].diagnostic = {};

            // 7. Reset diagnostic visual state
            container.querySelectorAll('.diagnostic-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Scroll to the diagnostic questions
            setTimeout(() => {
                diagnosticQuestionsDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }

        // Function to handle the diagnostic multiple choice click (for type: 'rating')
        function handleDiagnosticClick(optionDiv) {
            const coreId = parseInt(optionDiv.getAttribute('data-core-id'));
            const currentQKey = optionDiv.getAttribute('data-q-key');
            const text = optionDiv.getAttribute('data-text');

            const wrapper = document.getElementById(`reflection-${coreId}`);
            
            // 1. Clear selection for this specific question
            wrapper.querySelectorAll(`[data-q-key="${currentQKey}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });

            // 2. Select the clicked option
            optionDiv.classList.add('selected');

            // 3. Store the result
            results[coreId].diagnostic[currentQKey] = text;
            
            // Mark current question as answered (persists visible, read-only)
            document.getElementById(`q-wrapper-${coreId}-${currentQKey}`).classList.add('answered');

            // 4. Determine next step (sequential display)
            const nextQKey = { 'q1': 'q2', 'q2': 'q3' }[currentQKey];
            
            if (nextQKey) {
                // Inject and show next question
                const nextQWrapper = document.getElementById(`q-wrapper-${coreId}-${nextQKey}`);
                const nextOptionsDataKey = nextQKey === 'q2' ? 'q2OptionsData' : 'q3OptionsData';
                
                document.getElementById(`options-${coreId}-${nextQKey}`).innerHTML = renderUniqueOptions(coreId, nextQKey, results[coreId][nextOptionsDataKey]);

                // Reveal the next question in the list
                nextQWrapper.classList.remove('initial-hidden');
                
                // Scroll to the next question
                setTimeout(() => {
                    nextQWrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 50);

            } else {
                // All 3 questions are answered (currentQKey === 'q3')
                showFeedbackAndTask(coreId);
            }
        }
        
        // Function to handle the direct choice click (for type: 'choice' - Q6/Q7)
        function handleChoiceClick(optionDiv) {
            const id = parseInt(optionDiv.getAttribute('data-id'));
            const choice = optionDiv.getAttribute('data-choice');
            const index = optionDiv.getAttribute('data-index');
            const reflection = getReflectionById(id);

            // 1. Clear previous selection
            document.getElementById(`choice-list-${id}`).querySelectorAll('.direct-choice').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // 2. Select the clicked option
            optionDiv.classList.add('selected');

            // 3. Store result (Core rating is derived from the choice index for consistency in summary logic)
            // Low (1-2) = Index 1-2, Medium (3) = Index 3, High (4-5) = Index 4
            let coreRating;
            if (id === 6) { // Lesson Focus: Q6
                coreRating = index <= 2 ? 2 : (index === 3 ? 4 : 5);
            } else if (id === 7) { // Intervention Strategy: Q7
                coreRating = index <= 2 ? 2 : (index === 3 ? 4 : 5);
            }
            
            // Store results in the required format for the summary
            results[id] = { 
                coreRating: coreRating, 
                diagnostic: { 
                    q1: choice, // Use the choice as the primary diagnostic insight (q1)
                    q2: "N/A",  // Placeholder for summary generation
                    q3: "N/A",  // Placeholder for summary generation
                } 
            };
            
            // 4. Show feedback and task immediately
            showFeedbackAndTask(id, true);
        }

        // Function to display the personalized feedback and task after diagnostic is complete
        function showFeedbackAndTask(id, isChoice = false) {
            const reflection = getReflectionById(id);
            const data = results[id];
            
            // --- Determine the appropriate conversational feedback text ---
            let followUpText;
            
            // For Rating Questions (1-5 scale)
            if (!isChoice) {
                const q1_reason = data.diagnostic.q1.toLowerCase();
                const q2_reason = data.diagnostic.q2.toLowerCase();
                const q3_reason = data.diagnostic.q3.toLowerCase();

                if (data.coreRating <= 2) {
                    followUpText = `**I see you rated yourself low.** It takes courage to identify growth areas! You mentioned the **main barrier** is **${q1_reason}**. This is a great place to start. Let's focus on the actionable task below to give you a quick win and build confidence.`;
                } else if (data.coreRating === 3) {
                    followUpText = `**That's a good effort.** You're aware of the need to improve. Since you noted that you sometimes struggle with **${q2_reason}**, we can now focus on formalizing your approach to make this habit consistent.`;
                } else { // 4 or 5
                    followUpText = `**Wonderful! You're excelling.** It's clear you have strong systems in place. Since you're already doing great, and your classroom environment is often **${q3_reason}**, your next step should be moving this strength to the next level of complexity.`;
                }
            } 
            // For Choice Questions (Q6, Q7)
            else {
                const choice = data.diagnostic.q1;
                const coreArea = reflection.coreArea;
                
                if (choice.includes("explain") || choice.includes("real-life") || choice.includes("targeted support") || choice.includes("extra time") || choice.includes("concept or skill")) {
                    followUpText = `**That shows real CBE focus!** You chose **'${choice}'** as your primary action. This indicates a focus on **${coreArea}** and adjusting your practice to student needs. That's a strong habitâ€”now let's find a way to make it even more systematic.`;
                } else if (choice.includes("Move on") || choice.includes("Repeat the same explanation") || choice.includes("planned content") || choice.includes("recall key facts")) {
                    followUpText = `**Thank you for your honest answer.** You chose **'${choice}'**. This approach is common when time is tight, but it keeps the focus on coverage (syllabus) rather than **${coreArea}**. Let's use the task below to shift your focus to student mastery.`;
                } else {
                    followUpText = `**Interesting choice.** You selected **'${choice}'**. Let's reflect on how this impacts student learning. The actionable task below will give you a new approach to try next week.`;
                }
            }

            // Store generated feedback for summary
            data.feedback = followUpText;
            data.task = reflection.task;

            // 2. Inject feedback and task
            const followUpElement = document.getElementById(`follow-up-${id}`);
            const taskElement = document.getElementById(`task-${id}`);
            const feedbackDiv = document.getElementById(`feedback-${id}`);

            // Apply markdown conversion
            followUpElement.innerHTML = followUpText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
            taskElement.innerHTML = reflection.task.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 3. Show the feedback area with animation
            feedbackDiv.classList.add('visible');
            updateProgress();
        }


        // Function to move to the next question (Core Step)
        function moveToNextQuestion(currentIdString) {
            const currentId = parseInt(currentIdString);
            const currentWrapper = document.getElementById(`wrapper-${currentId}`);
            
            // Determine the next sequential core ID
            const nextId = currentId + 1;

            // Mark current card as completed and hide it
            currentWrapper.classList.add('completed');
            currentWrapper.classList.remove('active');
            currentWrapper.classList.add('hidden');
            
            if (nextId <= TOTAL_CORE_STEPS) {
                // Ensure the content for the next card is rendered
                renderReflectionCard(nextId);

                const nextWrapper = document.getElementById(`wrapper-${nextId}`);
                
                // Show the next question
                nextWrapper.classList.remove('hidden');
                nextWrapper.classList.add('active');
                
                // Scroll to the next question
                setTimeout(() => {
                    nextWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);

            } else {
                // End of core steps, show summary
                showWrapUpSummary();
            }
        }


        // --- SUMMARY FUNCTION (ADAPTIVE AND CONVERSATIONAL) ---

        function showWrapUpSummary() {
            let summaryContent = '';
            let growthAreas = [];
            
            // 1. Introduction based on overall performance
            const totalScore = Object.values(results).reduce((sum, data) => sum + data.coreRating, 0);
            const avgScore = totalScore / TOTAL_CORE_STEPS;

            if (avgScore >= 4.0) {
                summaryContent += `
                    **Excellent Work!** Your reflection shows that you already integrate **strong Competency-Based Education (CBE)** habits into your planning. You're a natural reflective practitioner and a fantastic asset to your school. Let's look at how you can deepen this mastery.
                    <br><hr>
                `;
            } else if (avgScore >= 3.0) {
                summaryContent += `
                    **Great Start!** Your honest self-assessment shows a solid foundation with clear potential for growth. You have many good habits already, but let's focus on formalizing them to achieve consistent CBE success.
                    <br><hr>
                `;
            } else {
                summaryContent += `
                    **Let's Get Focused!** Thank you for your honest assessment. Identifying areas for growth is the most important step. We've pinpointed foundational areas where focusing your energy will give you the biggest, quickest reward.
                    <br><hr>
                `;
            }

            summaryContent += `
                <h3 class="text-xl font-bold text-gray-800 mt-4 mb-2">ðŸ’¡ Your Personalized Takeaways:</h3>
                <p class="mb-4">Here is a summary of your self-assessment, combining your **core habit** with your **diagnostic reasons**:</p>
                <div class="space-y-4">
            `;
            
            // 2. Detailed Conversational Outline for each step
            for (let i = 1; i <= TOTAL_CORE_STEPS; i++) {
                const reflection = getReflectionById(i);
                const data = results[i];

                let category;
                let insight;

                if (reflection.type === 'rating') {
                    const q1 = data.diagnostic.q1.toLowerCase();
                    const q2 = data.diagnostic.q2.toLowerCase();
                    const q3 = data.diagnostic.q3.toLowerCase();
                    
                    if (data.coreRating >= 4) {
                        category = 'Strength';
                        insight = `You've demonstrated a **strong habit** here. You noted that you excel partly because you don't find it challenging to **${q1}** and your classroom environment is often **${q3}**. To push further, focus on extending your high-level planning.`;
                    } else if (data.coreRating === 3) {
                        category = 'Development Area';
                        insight = `This is a **key area for growth**. You're close, but you mentioned the primary challenge is **${q2}**. Formalizing this process will help you bridge the gap between 'sometimes' and 'always.'`;
                        growthAreas.push(reflection.coreArea);
                    } else {
                        category = 'Foundational Need';
                        insight = `This is a **foundational need**. Your main barrier appears to be **${q1}**. Start with the simplest suggested task from this scenario to build confidence and establish a strong CBE routine.`;
                        growthAreas.push(reflection.coreArea);
                    }
                } else if (reflection.type === 'choice') {
                    const choice = data.diagnostic.q1;
                    const isMastery = choice.includes("explain") || choice.includes("real-life") || choice.includes("targeted support") || choice.includes("extra time") || choice.includes("concept or skill");
                    
                    if (isMastery) {
                        category = 'Strength';
                        insight = `Your primary choice, **'${choice}'**, shows an immediate focus on mastery and targeted student needs. This is a strong CBE practice! Your next challenge is making this intentional, every single time.`;
                    } else {
                        category = 'Foundational Need';
                        insight = `Your primary choice, **'${choice}'**, indicates your focus is currently on content coverage (syllabus) or avoiding immediate issues. This is a common habit; the task below will help you consciously pivot to student mastery.`;
                        growthAreas.push(reflection.coreArea);
                    }
                }

                summaryContent += `
                    <div class="p-3 rounded-lg ${category === 'Strength' ? 'bg-emerald-50 border-emerald-300' : 'bg-red-50 border-red-300'} border">
                        <p class="font-semibold text-lg ${category === 'Strength' ? 'text-emerald-800' : 'text-red-800'}">
                            ${reflection.title} (${category})
                        </p>
                        <p class="text-sm text-gray-700 mt-1">${insight}</p>
                    </div>
                `;
            }
            
            summaryContent += `</div>`;
            
            // 3. Final Call to Action
            if (growthAreas.length > 0) {
                summaryContent += `
                    <h3 class="text-xl font-bold text-gray-800 mt-6 mb-2">ðŸŽ¯ Next Steps: Pick Your Battle</h3>
                    <p class="mb-4">
                        Based on your deep dive, you have foundational work in **${growthAreas[0]}** (e.g., Lesson Planning or Student Agency). We recommend choosing one of the actionable tasks from the scenarios you rated lowest and committing to trying it *tomorrow*.
                    </p>
                    <p class="font-semibold text-gray-700">
                        Remember: CBE mastery is built one small, intentional step at a time. Pick one task and make it a habit!
                    </p>
                `;
            }

            // Apply markdown conversion to the full summary content
            const fullSummaryHTML = summaryContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            summaryText.innerHTML = fullSummaryHTML;
            
            // Animate the summary box reveal
            summaryDiv.style.opacity = '0';
            summaryDiv.classList.remove('hidden');
            setTimeout(() => {
                summaryDiv.style.transition = 'opacity 1s ease-in';
                summaryDiv.style.opacity = '1';
                // Scroll to the summary
                summaryDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Initialize the flow on load
        window.onload = renderReflections;
    </script>
</body>
</html>
